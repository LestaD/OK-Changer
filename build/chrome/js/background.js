function in_array(a,b){for(var c=0;c<b.length;c++)if(b[c]==a)return!0;return!1}clones=function(a){var b=a instanceof Array?[]:{};for(i in a)"clone"!=i&&(b[i]=a[i]);return b};window.clones=clones;bg={tabs:[],storage:{},cmenu:{},news:{},debug:!0,log:function(a){bg.debug&&("object"==typeof a?(console.log("OKCHg: [object]"),console.log(a)):console.log("OKCHg: "+a))},error:function(a){bg.debug&&("object"==typeof a?(console.error("OKCHg: [object]"),console.error(a)):console.error("OKCHg: "+a))}};
bg.news.updateID=null;bg.news.lastViewID=-1;bg.news.updateRate=5E3;bg.news.notification=null;bg.news.start=function(){"undefined"!=bg.storage.news_last_id?bg.news.lastViewID=bg.storage.news_last_id:bg.storage.news_last_id=-1;bg.news.update();return!0};
bg.news.update=function(){$.getJSON("http://ok.onlife.mobi/news",function(a){if(0==a.error)for(id in a.news){var b=a.news[id];b.id<=bg.news.lastViewID||(bg.news.notification=webkitNotifications.createNotification("img/ico128.png",b.title,b.text),bg.news.notification.show(),bg.news.lastViewID=b.id)}else 12==a.error&&bg.news.clearID()});chrome.storage.local.set({news_last_id:bg.news.lastViewID},function(){});bg.news.updateID=setTimeout(bg.news.update,bg.news.updateRate)};bg.news.clicked=function(){};
bg.news.clearID=function(){chrome.storage.local.set({news_last_id:-1},function(){});bg.news.lastViewID=-1};bg.listenToTab=function(a){"tab_"+a in bg.tabs&&chrome.pageAction.show(a)};chrome.tabs.onSelectionChanged.addListener(bg.listenToTab);bg.addTab=function(a,b){var c=parseInt(b.tab.id);bg.tabs["tab_"+c]=b.tab;bg.log("...adding tab: "+c);a={storage:bg.storage};bg.log(a);chrome.pageAction.show(c);return a};
bg.removeTab=function(a,b){"tab_"+parseInt(a)in bg.tabs&&(delete bg.tabs["tab_"+parseInt(a)],bg.log("remove tab: "+a),chrome.pageAction.hide(a))};bg.checkTab=function(a,b,c){"tab_"+parseInt(a)in bg.tabs&&"undefined"!=typeof b.url&&("http://odnoklassniki.ru"!=b.url.substr(0,23)&&"http://www.odnoklassniki.ru"!=b.url.substr(0,27)?bg.removeTab(a):chrome.pageAction.show(a))};bg.updateTheme=function(a,b){bg.log("bg.updateTheme");bg.storage=a.data.storage;chrome.storage.local.set(bg.storage,function(){})};
bg.thinkMethod=function(a,b,c){if("function"==typeof bg[a])return bg[a](b,c);bg.error("Method not exists!")};bg.message=function(a,b,c){bg.log("bg.message");b.tab?"undefined"!=typeof a.method&&(a=bg.thinkMethod(a.method,a,b),c(a)):"undefined"!=typeof a.method&&c(bg.thinkMethod(a.method,a.data,b))};bg.sendDataToInjected=function(a,b){bg.log("...sendDataToInjected");bg.updateTabs(a)};
bg.updateTabs=function(a){bg.log("bg.updateTabs");bg.storage=clones(a.data);for(tabis in bg.tabs){var b=parseInt(tabis.replace("tab_",""));chrome.tabs.sendMessage(b,a,function(a){console.log("Response from message!");console.log(a)})}return{}};
bg.cmenu.linkHandler=function(a,b){bg.log(a);bg.log(b);var c=a.linkUrl?"http://www.odnoklassniki.ru/dk?st.cmd=addShare&st.s=1000&st._surl="+a.linkUrl:"http://www.odnoklassniki.ru/dk?st.cmd=addShare&st.s=1000&st._surl="+b.url;bg.log(c);chrome.windows.create({url:c,width:600,height:400,type:"popup"})};
bg.cmenu.selectionHandler=function(a,b){bg.log(a);bg.log(b);$.ajax({type:"POST",url:"http://m.odnoklassniki.ru/dk?st.cmd=userMain&_prevCmd=userMain&bk=UserStatus&tkn=1111",data:{"fr.posted":"owibdfzdekcsrbsumv0osrcgkyhiveljckoypc","fr.status":a.selectionText},success:function(a){}})};bg.ready=function(){bg.log("bg.ready");chrome.storage.local.get(null,function(a){bg.storage=clones(a)})};chrome.extension.onMessage.addListener(bg.message);chrome.tabs.onRemoved.addListener(bg.removeTab);chrome.tabs.onUpdated.addListener(bg.checkTab);
chrome.contextMenus.create({title:"\u041f\u043e\u0434\u0435\u043b\u0438\u0442\u044c\u0441\u044f \u0441\u0441\u044b\u043b\u043a\u043e\u0439",contexts:["link"],onclick:bg.cmenu.linkHandler});chrome.contextMenus.create({title:"\u041f\u043e\u0434\u0435\u043b\u0438\u0442\u044c\u0441\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435\u0439",contexts:["page"],onclick:bg.cmenu.linkHandler});bg.ready();
